<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£¯åº—è¨‚æˆ¿ç³»çµ±</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .hero-section {
            background: url('https://images.unsplash.com/photo-1566073771259-6a8506099945?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80') no-repeat center center;
            background-size: cover;
            height: 60vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .hero-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
        }
        .hero-content {
            position: relative;
            z-index: 1;
            color: white;
            text-align: center;
        }
        .search-box {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-top: -50px;
            position: relative;
            z-index: 2;
        }
    </style>
</head>
<body class="bg-light">

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">é£¯åº—è¨‚æˆ¿ç³»çµ±</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showSearch()">ğŸ” æœå°‹</a></li>
                    {% if user %}
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showMyBookings()">ğŸ“… è¨‚å–®</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showProfile()">ğŸ‘¤ æœƒå“¡ ({{ user.name }})</a></li>
                    <li class="nav-item"><a class="nav-link text-danger" href="/api/logout">ç™»å‡º</a></li>
                    {% else %}
                    <li class="nav-item"><a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal">ç™»å…¥ / è¨»å†Š</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="hero-section">
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <h1 class="display-4 fw-bold">äº«å—å®Œç¾çš„ä½å®¿é«”é©—</h1>
            <p class="lead">ç„¡è«–æ˜¯å•†å‹™å‡ºå·®é‚„æ˜¯åº¦å‡æ—…è¡Œï¼Œæˆ‘å€‘éƒ½æ˜¯æ‚¨çš„æœ€ä½³é¸æ“‡</p>
        </div>
    </div>

    <div class="container mb-5">
        <!-- æœå°‹å€å¡Š -->
        <div id="search-section" class="search-box">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">å…¥ä½æ—¥æœŸ</label>
                    <input type="date" class="form-control" id="startDate">
                </div>
                <div class="col-md-3">
                    <label class="form-label">é€€æˆ¿æ—¥æœŸ</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
                <div class="col-md-3">
                    <label class="form-label">äººæ•¸</label>
                    <select class="form-select" id="capacity">
                        <option value="0">ä¸é™</option>
                        <option value="1">1äºº</option>
                        <option value="2">2äºº</option>
                        <option value="4">4äºº</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-primary w-100" onclick="searchRooms()">æœå°‹ç©ºæˆ¿</button>
                </div>
            </div>
        </div>

        <!-- æˆ¿é–“åˆ—è¡¨ -->
        <div id="room-list" class="row mt-4"></div>

        <!-- æˆ‘çš„è¨‚å–® -->
        <div id="my-bookings" class="mt-4" style="display: none;">
            <h3>æˆ‘çš„é è¨‚ç´€éŒ„</h3>
            <div id="booking-list" class="list-group mt-3"></div>
        </div>

        <!-- æœƒå“¡è³‡æ–™ -->
        <div id="profile-section" class="mt-4" style="display: none;">
            <div class="card mx-auto" style="max-width: 600px;">
                <div class="card-header bg-info text-white">æœƒå“¡è³‡æ–™ä¿®æ”¹</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label>å§“å</label>
                        <input type="text" id="p_name" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>Email</label>
                        <input type="email" id="p_email" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>æ‰‹æ©Ÿ</label>
                        <input type="text" id="p_phone" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>ç”Ÿæ—¥</label>
                        <input type="date" id="p_birth" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>æ€§åˆ¥</label>
                        <select id="p_gender" class="form-select">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="Male">ç”·</option>
                            <option value="Female">å¥³</option>
                            <option value="Other">å…¶ä»–</option>
                        </select>
                    </div>
                    <button class="btn btn-success w-100" onclick="updateProfile()">å„²å­˜ä¿®æ”¹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login/Register Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">æœƒå“¡ç™»å…¥</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    
                    <!-- ç™»å…¥è¡¨å–® -->
                    <div id="loginForm">
                        <div class="alert alert-info py-2">éœ€è¼¸å…¥æ­£ç¢ºçš„å§“åã€Emailèˆ‡æ‰‹æ©Ÿæ‰èƒ½ç™»å…¥</div>
                        <div class="mb-3">
                            <label>å§“å</label>
                            <input type="text" class="form-control" id="loginName">
                        </div>
                        <div class="mb-3">
                            <label>Email</label>
                            <input type="email" class="form-control" id="loginEmail">
                        </div>
                        <div class="mb-3">
                            <label>æ‰‹æ©Ÿ</label>
                            <input type="text" class="form-control" id="loginPhone">
                        </div>
                        <button class="btn btn-primary w-100 mb-2" onclick="login()">ç™»å…¥</button>
                        <div class="text-center">
                            <a href="#" onclick="toggleAuthMode('register')">é‚„æ²’å¸³è™Ÿï¼Ÿé»æ­¤è¨»å†Š</a>
                        </div>
                    </div>

                    <!-- è¨»å†Šè¡¨å–® (é è¨­éš±è—) -->
                    <div id="registerForm" style="display: none;">
                        <div class="alert alert-warning py-2">è«‹å¡«å¯«è©³ç´°è³‡æ–™ä»¥å®Œæˆè¨»å†Š</div>
                        <div class="mb-2">
                            <label>å§“å <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="regName">
                        </div>
                        <div class="mb-2">
                            <label>Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="regEmail">
                        </div>
                        <div class="mb-2">
                            <label>æ‰‹æ©Ÿ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="regPhone">
                        </div>
                        <div class="mb-2">
                            <label>ç”Ÿæ—¥</label>
                            <input type="date" class="form-control" id="regBirth">
                        </div>
                        <div class="mb-3">
                            <label>æ€§åˆ¥</label>
                            <select class="form-select" id="regGender">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="Male">ç”·</option>
                                <option value="Female">å¥³</option>
                                <option value="Other">å…¶ä»–</option>
                            </select>
                        </div>
                        <button class="btn btn-success w-100 mb-2" onclick="register()">è¨»å†Šä¸¦ç™»å…¥</button>
                        <div class="text-center">
                            <a href="#" onclick="toggleAuthMode('login')">å·²æœ‰å¸³è™Ÿï¼Ÿè¿”å›ç™»å…¥</a>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- JS Logic -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // åˆ‡æ›ç™»å…¥/è¨»å†Šæ¨¡å¼
        function toggleAuthMode(mode) {
            if(mode === 'register') {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('registerForm').style.display = 'block';
                document.getElementById('modalTitle').innerText = 'æ–°æœƒå“¡è¨»å†Š';
            } else {
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('registerForm').style.display = 'none';
                document.getElementById('modalTitle').innerText = 'æœƒå“¡ç™»å…¥';
            }
        }

        // ç™»å…¥åŠŸèƒ½
        async def login() { // JS syntax correction: async function login()
            // ä¿®æ­£ç‚ºæ¨™æº– JS å¯«æ³•
        }
        
        async function login() {
            const name = document.getElementById('loginName').value;
            const email = document.getElementById('loginEmail').value;
            const phone = document.getElementById('loginPhone').value;

            const res = await fetch('/api/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, email, phone })
            });

            const data = await res.json();
            if (res.ok) {
                alert('ç™»å…¥æˆåŠŸ: ' + data.user.name);
                location.reload();
            } else {
                alert(data.error);
            }
        }

        // è¨»å†ŠåŠŸèƒ½
        async function register() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const phone = document.getElementById('regPhone').value;
            const birth_date = document.getElementById('regBirth').value;
            const gender = document.getElementById('regGender').value;

            if(!name || !email || !phone) {
                alert("è«‹å¡«å¯«å¿…å¡«æ¬„ä½");
                return;
            }

            const res = await fetch('/api/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, email, phone, birth_date, gender })
            });

            const data = await res.json();
            if (res.ok) {
                alert('è¨»å†ŠæˆåŠŸï¼æ­¡è¿ ' + data.user.name);
                location.reload();
            } else {
                alert(data.error);
            }
        }

        // æœå°‹æˆ¿é–“
        async function searchRooms() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const cap = document.getElementById('capacity').value;

            if (!start || !end) return alert("è«‹é¸æ“‡æ—¥æœŸ");

            const res = await fetch(`/api/search?start_date=${start}&end_date=${end}&capacity=${cap}`);
            const rooms = await res.json();
            
            if (rooms.error) return alert(rooms.error);

            const list = document.getElementById('room-list');
            list.innerHTML = rooms.length ? '' : '<div class="col-12 text-center">æ²’æœ‰ç¬¦åˆçš„ç©ºæˆ¿</div>';

            rooms.forEach(r => {
                list.innerHTML += `
                    <div class="col-md-4 mb-4">
                        <div class="card h-100">
                            <img src="https://source.unsplash.com/400x300/?hotel,room,${r.type_name}" class="card-img-top" alt="Room">
                            <div class="card-body">
                                <h5 class="card-title">${r.type_name} (${r.room_number})</h5>
                                <p class="card-text">${r.description}</p>
                                <p class="fw-bold text-primary">åƒ¹æ ¼: $${r.base_price} / æ™š</p>
                                <p class="text-muted"><small>å®¹ç´: ${r.capacity} äºº</small></p>
                                <button class="btn btn-primary w-100" onclick="bookRoom(${r.room_id})">ç«‹å³é è¨‚</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            showSection('search-section');
            document.getElementById('room-list').style.display = 'flex';
        }

        // é è¨‚æˆ¿é–“
        async function bookRoom(roomId) {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            
            if(!confirm(`ç¢ºå®šè¦é è¨‚å—ï¼Ÿ\nå…¥ä½: ${start}\né€€æˆ¿: ${end}`)) return;

            const res = await fetch('/api/book', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ room_id: roomId, start_date: start, end_date: end })
            });
            
            const data = await res.json();
            if(res.status === 401) {
                alert("è«‹å…ˆç™»å…¥æœƒå“¡");
                var myModal = new bootstrap.Modal(document.getElementById('loginModal'));
                myModal.show();
            } else if(res.ok) {
                alert("é è¨‚æˆåŠŸï¼ç¸½é‡‘é¡: $" + data.total_price);
                showMyBookings();
            } else {
                alert(data.error);
            }
        }

        // é¡¯ç¤ºæˆ‘çš„è¨‚å–®
        async function showMyBookings() {
            showSection('my-bookings');
            const res = await fetch('/api/my-bookings');
            const bookings = await res.json();
            const list = document.getElementById('booking-list');
            list.innerHTML = '';
            
            if(bookings.length === 0) {
                list.innerHTML = '<p class="text-center text-muted">ç›®å‰æ²’æœ‰è¨‚å–®</p>';
                return;
            }

            bookings.forEach(b => {
                const statusColor = b.status === 'Cancelled' ? 'text-danger' : 'text-success';
                const actionBtn = b.status === 'Confirmed' 
                    ? `<button class="btn btn-sm btn-outline-danger float-end" onclick="cancelBooking(${b.reservation_id})">å–æ¶ˆè¨‚å–®</button>` 
                    : '<span class="float-end text-muted">ç„¡æ³•å–æ¶ˆ</span>';
                
                list.innerHTML += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">æˆ¿è™Ÿ ${b.room_number} (${b.type_name})</h5>
                            <small>${b.created_at}</small>
                        </div>
                        <p class="mb-1">å…¥ä½: ${b.check_in_date} | é€€æˆ¿: ${b.check_out_date}</p>
                        <p class="mb-1 fw-bold">ç¸½åƒ¹: $${b.total_price}</p>
                        <small class="${statusColor} fw-bold">ç‹€æ…‹: ${b.status}</small>
                        ${actionBtn}
                    </div>
                `;
            });
        }

        // å–æ¶ˆè¨‚å–®
        async function cancelBooking(id) {
            if(!confirm("ç¢ºå®šè¦å–æ¶ˆé€™ç­†è¨‚å–®å—ï¼Ÿ")) return;
            const res = await fetch('/api/cancel', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ reservation_id: id })
            });
            if(res.ok) {
                alert("å·²å–æ¶ˆ");
                showMyBookings();
            }
        }

        // é¡¯ç¤ºæœƒå“¡è³‡æ–™
        async function showProfile() {
            showSection('profile-section');
            const res = await fetch('/api/profile');
            if(res.status === 401) return location.reload();
            const user = await res.json();
            
            document.getElementById('p_name').value = user.name;
            document.getElementById('p_email').value = user.email;
            document.getElementById('p_phone').value = user.phone;
            document.getElementById('p_birth').value = user.birth_date || '';
            document.getElementById('p_gender').value = user.gender || '';
        }

        // æ›´æ–°æœƒå“¡è³‡æ–™
        async function updateProfile() {
            const data = {
                name: document.getElementById('p_name').value,
                email: document.getElementById('p_email').value,
                phone: document.getElementById('p_phone').value,
                birth_date: document.getElementById('p_birth').value,
                gender: document.getElementById('p_gender').value
            };
            
            const res = await fetch('/api/profile', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if(res.ok) alert("è³‡æ–™å·²æ›´æ–°");
            else alert("æ›´æ–°å¤±æ•—");
        }

        // é é¢åˆ‡æ› helper
        function showSection(id) {
            document.getElementById('search-section').style.display = 'none';
            document.getElementById('room-list').style.display = 'none';
            document.getElementById('my-bookings').style.display = 'none';
            document.getElementById('profile-section').style.display = 'none';
            
            document.getElementById(id).style.display = 'block';
        }
        function showSearch() { 
            showSection('search-section'); 
            document.getElementById('room-list').style.display = 'flex';
        }
    </script>
</body>
</html>
