<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£¯åº—è¨‚æˆ¿ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 20px; background-color: #f8f9fa; }
        .card { transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .status-Confirmed { color: #198754; font-weight: bold; }
        .status-Cancelled { color: #dc3545; text-decoration: line-through; }
    </style>
</head>
<body>
    <div class="container">
        <!-- é ‚éƒ¨ -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="fw-bold text-primary">ğŸ¨ è±ªè¯é£¯åº—è¨‚æˆ¿ç³»çµ±</h1>
            <div id="userArea"></div>
        </div>
        
        <!-- é ç±¤ -->
        <ul class="nav nav-pills mb-4" id="myTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-pane">ğŸ” æœå°‹è¨‚æˆ¿</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="my-booking-tab" data-bs-toggle="tab" data-bs-target="#booking-pane" onclick="loadMyBookings()">ğŸ“… æˆ‘çš„è¨‚å–®</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile-pane" onclick="loadProfile()">ğŸ‘¤ æœƒå“¡ä¸­å¿ƒ</button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- 1. æœå°‹é é¢ -->
            <div class="tab-pane fade show active" id="search-pane">
                <div class="card p-4 mb-4 border-0 shadow-sm">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold">å…¥ä½æ—¥æœŸ</label>
                            <input type="date" id="startDate" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">é€€æˆ¿æ—¥æœŸ</label>
                            <input type="date" id="endDate" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">å…¥ä½äººæ•¸</label>
                            <select id="capacity" class="form-select">
                                <option value="0">ä¸é™</option>
                                <option value="2">2äºº</option>
                                <option value="4">4äºº</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button onclick="searchRooms()" class="btn btn-primary w-100 py-2">æœå°‹ç©ºæˆ¿</button>
                        </div>
                    </div>
                </div>
                <div id="resultsArea" class="row">
                    <div class="col-12 text-center text-muted p-5"><h4>ğŸ‘‹ è«‹é¸æ“‡æ—¥æœŸé–‹å§‹æœå°‹</h4></div>
                </div>
            </div>

            <!-- 2. è¨‚å–®ç®¡ç† -->
            <div class="tab-pane fade" id="booking-pane">
                <div class="card border-0 shadow-sm p-4">
                    <h4 class="mb-4">æˆ‘çš„é è¨‚ç´€éŒ„</h4>
                    <div id="bookingList" class="list-group list-group-flush"></div>
                </div>
            </div>

            <!-- 3. æœƒå“¡ä¸­å¿ƒ -->
            <div class="tab-pane fade" id="profile-pane">
                <div class="card p-4 shadow-sm mx-auto" style="max-width: 600px;">
                    <h4 class="mb-4 text-center">ç·¨è¼¯å€‹äººæª”æ¡ˆ</h4>
                    <form id="profileForm" onsubmit="return false;">
                        <div class="mb-3">
                            <label class="form-label">å§“å</label>
                            <input type="text" id="pfName" class="form-control">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" id="pfEmail" class="form-control">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">æ‰‹æ©Ÿ</label>
                                <input type="tel" id="pfPhone" class="form-control">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ç”Ÿæ—¥</label>
                                <input type="date" id="pfBirth" class="form-control">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">æ€§åˆ¥</label>
                                <select id="pfGender" class="form-select">
                                    <option value="">è«‹é¸æ“‡</option>
                                    <option value="Male">ç”·</option>
                                    <option value="Female">å¥³</option>
                                    <option value="Other">å…¶ä»–</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="saveProfile()" class="btn btn-success w-100">å„²å­˜è®Šæ›´</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ç™»å…¥ Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">æœƒå“¡ç™»å…¥</h5>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label>å§“å <span class="text-danger">*</span></label>
                        <input type="text" id="loginName" class="form-control" placeholder="æ–°ç”¨æˆ¶å¿…å¡«">
                    </div>
                    <div class="mb-3">
                        <label>Email</label>
                        <input type="email" id="loginEmail" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>æ‰‹æ©Ÿ</label>
                        <input type="tel" id="loginPhone" class="form-control">
                    </div>
                    <div class="text-muted small">éœ€å¡«å¯«æ­£ç¢ºçš„ Email å’Œæ‰‹æ©Ÿæ‰èƒ½ç™»å…¥èˆŠå¸³è™Ÿ</div>
                </div>
                <div class="modal-footer border-0">
                    <button onclick="doLogin()" class="btn btn-primary w-100">ç™»å…¥ / è¨»å†Š</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentUser = {{ user|tojson|safe }};

        function init() {
            const userArea = document.getElementById('userArea');
            if (currentUser) {
                userArea.innerHTML = `<span class="me-2">Hi, <strong>${currentUser.first_name}</strong></span> <a href="/api/logout" class="btn btn-sm btn-outline-secondary">ç™»å‡º</a>`;
            } else {
                userArea.innerHTML = `<button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#loginModal">æœƒå“¡ç™»å…¥</button>`;
            }
        }
        init();

        async function doLogin() {
            const name = document.getElementById('loginName').value;
            const email = document.getElementById('loginEmail').value;
            const phone = document.getElementById('loginPhone').value;
            
            if(!email || !phone) return alert('è«‹å®Œæ•´å¡«å¯« Email å’Œ æ‰‹æ©Ÿ');

            const res = await fetch('/api/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name, email, phone})
            });
            
            if(res.ok) {
                location.reload();
            } else {
                const err = await res.json();
                alert(err.error);
            }
        }

        async function loadProfile() {
            if(!currentUser) {
                alert('è«‹å…ˆç™»å…¥');
                document.getElementById('search-tab').click();
                return;
            }
            const res = await fetch('/api/profile');
            const user = await res.json();
            
            document.getElementById('pfName').value = user.first_name || '';
            document.getElementById('pfEmail').value = user.email || '';
            document.getElementById('pfPhone').value = user.phone || '';
            document.getElementById('pfBirth').value = user.birth_date || '';
            document.getElementById('pfGender').value = user.gender || '';
        }

        async function saveProfile() {
            const data = {
                first_name: document.getElementById('pfName').value,
                email: document.getElementById('pfEmail').value,
                phone: document.getElementById('pfPhone').value,
                birth_date: document.getElementById('pfBirth').value,
                gender: document.getElementById('pfGender').value
            };
            const res = await fetch('/api/profile', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if(res.ok) {
                alert('æ›´æ–°æˆåŠŸï¼');
                location.reload();
            } else {
                alert('æ›´æ–°å¤±æ•—ï¼ŒEmail æˆ–æ‰‹æ©Ÿå¯èƒ½å·²è¢«ä½¿ç”¨');
            }
        }

        async function searchRooms() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const capacity = document.getElementById('capacity').value;

            if(!start || !end) return alert('è«‹é¸æ“‡æ—¥æœŸ');
            if(start >= end) return alert('é€€æˆ¿æ—¥æœŸå¿…é ˆæ™šæ–¼å…¥ä½æ—¥æœŸ');

            const res = await fetch(`/api/search?start_date=${start}&end_date=${end}&capacity=${capacity}`);
            const rooms = await res.json();
            const container = document.getElementById('resultsArea');
            container.innerHTML = '';

            if(rooms.length === 0) {
                container.innerHTML = '<div class="col-12 text-center p-5"><h5>ç„¡ç¬¦åˆæ¢ä»¶ç©ºæˆ¿</h5></div>';
                return;
            }

            const groupedRooms = {};
            rooms.forEach(room => {
                if (!groupedRooms[room.type_name]) {
                    groupedRooms[room.type_name] = { info: room, list: [] };
                }
                groupedRooms[room.type_name].list.push(room);
            });

            Object.keys(groupedRooms).forEach(typeName => {
                const group = groupedRooms[typeName];
                const info = group.info;
                let opts = '';
                group.list.forEach(r => opts += `<option value="${r.room_id}">${r.room_number} è™Ÿ</option>`);

                container.innerHTML += `
                    <div class="col-md-6 mb-4">
                        <div class="card h-100 shadow-sm border-0">
                            <div class="card-header bg-white border-0 pt-3 d-flex justify-content-between">
                                <h4 class="fw-bold">${typeName}</h4>
                                <span class="badge bg-info text-dark">${info.capacity} äººæˆ¿</span>
                            </div>
                            <div class="card-body">
                                <h2 class="text-primary fw-bold">$${info.base_price} <small class="fs-6 text-muted">/ æ™š</small></h2>
                                <p class="text-secondary">${info.description}</p>
                                <div class="bg-light p-3 rounded">
                                    <label class="small fw-bold text-muted">é¸æ“‡æˆ¿è™Ÿï¼š</label>
                                    <div class="input-group">
                                        <select class="form-select" id="select-${typeName}">${opts}</select>
                                        <button class="btn btn-primary" onclick="bookSelected('${typeName}')">é è¨‚</button>
                                    </div>
                                    <div class="mt-2 small text-success">å‰©é¤˜ ${group.list.length} é–“</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function bookSelected(typeName) {
            const sel = document.getElementById(`select-${typeName}`);
            bookRoom(sel.value, sel.options[sel.selectedIndex].text);
        }

        async function bookRoom(roomId, roomNum) {
            if(!currentUser) { new bootstrap.Modal(document.getElementById('loginModal')).show(); return; }
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            
            // è¨ˆç®—å¤©æ•¸é ä¼°é‡‘é¡ (å‰ç«¯ç°¡å–®è¨ˆç®—ï¼Œæº–ç¢ºé‡‘é¡ä»¥å¾Œç«¯ç‚ºæº–)
            const days = (new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24);
            
            if(!confirm(`é è¨‚è³‡è¨Šï¼š\næˆ¿è™Ÿï¼š${roomNum}\næ—¥æœŸï¼š${start} ~ ${end} (${days}æ™š)\n\nç¢ºå®šè¦é€å‡ºå—ï¼Ÿ`)) return;

            const res = await fetch('/api/book', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ room_id: roomId, start_date: start, end_date: end })
            });

            if(res.ok) {
                const result = await res.json();
                alert(`ğŸ‰ è¨‚æˆ¿æˆåŠŸï¼\nç¸½é‡‘é¡ï¼š$${result.total_price}`);
                document.getElementById('my-booking-tab').click();
            } else {
                alert('è¨‚æˆ¿å¤±æ•—');
            }
        }

        async function loadMyBookings() {
            if(!currentUser) return;
            const res = await fetch('/api/my-bookings');
            const bookings = await res.json();
            const list = document.getElementById('bookingList');
            list.innerHTML = '';
            
            if(bookings.length===0) { list.innerHTML='<div class="text-center p-4">ç„¡è¨‚å–®</div>'; return; }

            bookings.forEach(b => {
                const cancelBtn = b.status === 'Confirmed' ? 
                    `<button onclick="cancelBooking(${b.reservation_id})" class="btn btn-outline-danger btn-sm float-end">å–æ¶ˆ</button>` : '';
                list.innerHTML += `
                    <div class="list-group-item p-3">
                        ${cancelBtn}
                        <h5 class="mb-1">${b.type_name} (${b.room_number})</h5>
                        <small>${b.check_in_date} ~ ${b.check_out_date}</small><br>
                        <strong>ç¸½åƒ¹ï¼š$${b.total_price}</strong>
                        <span class="float-end status-${b.status}">${b.status}</span>
                    </div>
                `;
            });
        }

        async function cancelBooking(id) {
            if(!confirm('ç¢ºå®šå–æ¶ˆï¼Ÿ')) return;
            const res = await fetch('/api/cancel', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ reservation_id: id })
            });
            if(res.ok) { alert('å·²å–æ¶ˆ'); loadMyBookings(); }
        }
    </script>
</body>
</html>
