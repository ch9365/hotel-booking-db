<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£¯åº—è¨‚æˆ¿ç³»çµ±</title>
    <!-- Bootstrap CSS æ¡†æ¶ï¼Œå¿«é€Ÿç¾åŒ–æŒ‰éˆ•ã€è¡¨æ ¼èˆ‡æ’ç‰ˆ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* è‡ªå®šç¾© CSSï¼šé¦–é å¤§åœ– (Hero Section) */
        .hero-section {
            /* {{ url_for(...) }} æ˜¯ Flask çš„èªæ³•ï¼Œç”¨ä¾†ç”¢ç”Ÿéœæ…‹æª”æ¡ˆçš„è·¯å¾‘ */
            background: url("{{ url_for('static', filename='images/Gemini_Generated_hotel_lobby.jpeg') }}") no-repeat center center;
            background-size: cover;
            height: 60vh; /* é«˜åº¦ä½”è¦–çª—çš„ 60% */
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* é»‘è‰²åŠé€æ˜é®ç½©ï¼Œè®“ç™½å­—æ›´æ¸…æ™° */
        .hero-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
        }
        .hero-content {
            position: relative;
            z-index: 1; /* ç¢ºä¿æ–‡å­—æµ®åœ¨é®ç½©ä¹‹ä¸Š */
            color: white;
            text-align: center;
        }

        /* æœå°‹æ¡†å€å¡Šï¼šå¾€ä¸Šæµ®å‹• (-50px) å‰µé€ å±¤æ¬¡æ„Ÿ */
        .search-box {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-top: -50px;
            position: relative;
            z-index: 2;
        }
    </style>
</head>
<body class="bg-light">

    <!-- å°è¦½åˆ— -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">é£¯åº—è¨‚æˆ¿ç³»çµ±</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <!-- onclick äº‹ä»¶ç¶å®š JS å‡½å¼ï¼Œåˆ‡æ›é¡¯ç¤ºå€å¡Š -->
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showSearch()">ğŸ” æœå°‹</a></li>
                    {% if user %}

                    <!-- Jinja2 èªæ³•ï¼šå¾Œç«¯ Python åˆ¤æ–· user æ˜¯å¦å­˜åœ¨ -->
                    <!-- é€™ç¨®å¯«æ³•æ˜¯åœ¨ã€Œä¼ºæœå™¨ç«¯ã€å°±æ±ºå®šå¥½è¦å‚³ä»€éº¼ HTML çµ¦ç€è¦½å™¨ -->
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showMyBookings()">ğŸ“… è¨‚å–®</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showProfile()">ğŸ‘¤ æœƒå“¡ ({{ user.name }})</a></li>
                    <li class="nav-item"><a class="nav-link text-danger" href="/api/logout">ç™»å‡º</a></li>
                    {% else %}

                    <!-- data-bs-toggle="modal" æ˜¯ Bootstrap èªæ³•ï¼Œé»æ“Šå¾Œæœƒå½ˆå‡ºè¦–çª— -->
                    <li class="nav-item"><a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal">ç™»å…¥ / è¨»å†Š</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- é¦–é å¤§åœ–å€å¡Š -->
    <div class="hero-section">
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <h1 class="display-4 fw-bold">äº«å—ç¾å¥½çš„ä½å®¿é«”é©—</h1>
        </div>
    </div>

    <div class="container mb-5">
        <!-- æœå°‹å€å¡Š(é è¨­é¡¯ç¤º) -->
        <div id="search-section" class="search-box">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">å…¥ä½æ—¥æœŸ</label>
                    <!-- onchange: ç•¶ä½¿ç”¨è€…é¸å®Œæ—¥æœŸå¾Œï¼Œè‡ªå‹•è§¸ç™¼ updateEndDateMin() -->
                    <input type="date" class="form-control" id="startDate" onchange="updateEndDateMin()">
                </div>
                <div class="col-md-3">
                    <label class="form-label">é€€æˆ¿æ—¥æœŸ</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
                <div class="col-md-3">
                    <label class="form-label">äººæ•¸</label>
                    <select class="form-select" id="capacity">
                        <option value="0">ä¸é™</option>
                        <option value="2">2äºº</option>
                        <option value="4">4äºº</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-primary w-100" onclick="searchRooms()">æœå°‹ç©ºæˆ¿</button>
                </div>
            </div>
        </div>

        <!-- æˆ¿é–“åˆ—è¡¨ (æœå°‹çµæœ) (JS å‹•æ…‹å¡«å…¥å…§å®¹) -->
        <div id="room-list" class="row mt-4"></div>

        <!-- æˆ‘çš„è¨‚å–® (é è¨­éš±è— display: none) -->
        <div id="my-bookings" class="mt-4" style="display: none;">
            <h3>æˆ‘çš„é è¨‚ç´€éŒ„</h3>
            <div id="booking-list" class="list-group mt-3"></div>
        </div>

        <!-- æœƒå“¡è³‡æ–™ (é è¨­éš±è—) -->
        <div id="profile-section" class="mt-4" style="display: none;">
            <div class="card mx-auto" style="max-width: 600px;">
                <div class="card-header bg-info text-white">æœƒå“¡è³‡æ–™ä¿®æ”¹</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label>å§“å</label>
                        <input type="text" id="p_name" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>Email</label>
                        <input type="email" id="p_email" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>æ‰‹æ©Ÿ</label>
                        <input type="text" id="p_phone" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>ç”Ÿæ—¥</label>
                        <input type="date" id="p_birth" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>æ€§åˆ¥</label>
                        <select id="p_gender" class="form-select">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="Male">ç”·</option>
                            <option value="Female">å¥³</option>
                            <option value="Other">å…¶ä»–</option>
                        </select>
                    </div>
                    <button class="btn btn-success w-100" onclick="updateProfile()">å„²å­˜ä¿®æ”¹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç™»å…¥/è¨»å†Šå½ˆè·³è¦–çª— -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">æœƒå“¡ç™»å…¥</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    
                    <!-- ç™»å…¥è¡¨å–® -->
                    <div id="loginForm">
                        <div class="alert alert-info py-2">éœ€è¼¸å…¥æ­£ç¢ºçš„å§“åã€Emailèˆ‡æ‰‹æ©Ÿæ‰èƒ½ç™»å…¥</div>
                        <div class="mb-3">
                            <label>å§“å</label>
                            <input type="text" class="form-control" id="loginName">
                        </div>
                        <div class="mb-3">
                            <label>Email</label>
                            <input type="email" class="form-control" id="loginEmail">
                        </div>
                        <div class="mb-3">
                            <label>æ‰‹æ©Ÿ</label>
                            <input type="text" class="form-control" id="loginPhone">
                        </div>
                        <button class="btn btn-primary w-100 mb-2" onclick="login()">ç™»å…¥</button>
                        <div class="text-center">
                            <!-- åˆ‡æ›åˆ°è¨»å†Šæ¨¡å¼ -->
                            <a href="#" onclick="toggleAuthMode('register')">é‚„æ²’å¸³è™Ÿï¼Ÿé»æ­¤è¨»å†Š</a>
                        </div>
                    </div>

                    <!-- è¨»å†Šè¡¨å–® (é è¨­éš±è—) -->
                    <div id="registerForm" style="display: none;">
                        <div class="alert alert-warning py-2">è«‹å¡«å¯«è©³ç´°è³‡æ–™ä»¥å®Œæˆè¨»å†Š</div>
                        <div class="mb-2">
                            <label>å§“å <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="regName">
                        </div>
                        <div class="mb-2">
                            <label>Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="regEmail">
                        </div>
                        <div class="mb-2">
                            <label>æ‰‹æ©Ÿ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="regPhone">
                        </div>
                        <div class="mb-2">
                            <label>ç”Ÿæ—¥</label>
                            <input type="date" class="form-control" id="regBirth">
                        </div>
                        <div class="mb-3">
                            <label>æ€§åˆ¥</label>
                            <select class="form-select" id="regGender">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="Male">ç”·</option>
                                <option value="Female">å¥³</option>
                                <option value="Other">å…¶ä»–</option>
                            </select>
                        </div>
                        <button class="btn btn-success w-100 mb-2" onclick="register()">è¨»å†Šä¸¦ç™»å…¥</button>
                        <div class="text-center">
                            <a href="#" onclick="toggleAuthMode('login')">å·²æœ‰å¸³è™Ÿï¼Ÿè¿”å›ç™»å…¥</a>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥ Bootstrap JS (è®“ Modal å’Œ Navbar åŠŸèƒ½æ­£å¸¸é‹ä½œ) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // åˆå§‹åŒ–ï¼šè¨­å®šæ—¥æœŸè¼¸å…¥æ¡†çš„é™åˆ¶
        window.onload = function() {
            // å–å¾—ä»Šå¤©çš„æ—¥æœŸå­—ä¸²ï¼Œæ ¼å¼ç‚º YYYY-MM-DD
            const today = new Date().toISOString().split('T')[0];

            // 1. è¨­å®šæœå°‹æ—¥æœŸçš„æœ€å°å€¼ (ä¸èƒ½é¸éå»)
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            if(startDateInput) startDateInput.min = today;
            if(endDateInput) endDateInput.min = today;
            
            // 2. è¨­å®šç”Ÿæ—¥çš„æœ€å¤§å€¼ (ä¸èƒ½é¸æœªä¾†)
            const regBirthInput = document.getElementById('regBirth'); // è¨»å†Šè¡¨å–®çš„ç”Ÿæ—¥
            const profileBirthInput = document.getElementById('p_birth'); // æœƒå“¡è³‡æ–™ä¿®æ”¹çš„ç”Ÿæ—¥
            // max = today
            if(regBirthInput) regBirthInput.max = today; 
            if(profileBirthInput) profileBirthInput.max = today;
        };


        // ç•¶å…¥ä½æ—¥æœŸæ”¹è®Šæ™‚ï¼Œé€£å‹•é™åˆ¶é€€æˆ¿æ—¥æœŸ
        function updateEndDateMin() {
            const startVal = document.getElementById('startDate').value;
            if(startVal) {
                const startDate = new Date(startVal);
                startDate.setDate(startDate.getDate() + 1); // é€€æˆ¿æ—¥è‡³å°‘è¦æ˜¯éš”å¤©
                const nextDay = startDate.toISOString().split('T')[0];
                
                const endDateInput = document.getElementById('endDate');
                endDateInput.min = nextDay;
                
                // å¦‚æœåŸæœ¬é¸çš„æ—¥æœŸå¤ªæ—©ï¼Œå¼·åˆ¶ä¿®æ­£
                if(endDateInput.value < nextDay) {
                    endDateInput.value = nextDay;
                }
            }
        }

        // åˆ‡æ›ç™»å…¥/è¨»å†Šæ¨¡å¼ ( UI åˆ‡æ›é‚è¼¯)
        function toggleAuthMode(mode) {
            if(mode === 'register') {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('registerForm').style.display = 'block';
                document.getElementById('modalTitle').innerText = 'æ–°æœƒå“¡è¨»å†Š';
            } else {
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('registerForm').style.display = 'none';
                document.getElementById('modalTitle').innerText = 'æœƒå“¡ç™»å…¥';
            }
        }

        // ç™»å…¥åŠŸèƒ½
        async function login() {
            const name = document.getElementById('loginName').value;
            const email = document.getElementById('loginEmail').value;
            const phone = document.getElementById('loginPhone').value;

            if(!name || !email || !phone) {
                alert("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½");
                return;
            }

            try {
                // ç™¼é€ POST è«‹æ±‚çµ¦ Python å¾Œç«¯
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    // å°‡ç‰©ä»¶è½‰ç‚º JSON å­—ä¸²
                    body: JSON.stringify({ name, email, phone })
                });

                const data = await res.json();
                if (res.ok) {
                    alert('ç™»å…¥æˆåŠŸ: ' + data.user.name);
                    location.reload(); // é‡æ–°æ•´ç†é é¢ä»¥æ›´æ–° Navbar ç‹€æ…‹
                } else {
                    alert(data.error);
                }
            } catch (err) {
                console.error(err);
                alert("é€£ç·šéŒ¯èª¤");
            }
        }

        // è¨»å†ŠåŠŸèƒ½
        async function register() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const phone = document.getElementById('regPhone').value;
            const birth_date = document.getElementById('regBirth').value;
            const gender = document.getElementById('regGender').value;

            if(!name || !email || !phone) {
                alert("è«‹å¡«å¯«å¿…å¡«æ¬„ä½ (å§“åã€Emailã€æ‰‹æ©Ÿ)");
                return;
            }
            
            // å‰ç«¯é˜²å‘†ï¼šç”Ÿæ—¥ä¸èƒ½æ˜¯æœªä¾†
            if (birth_date) {
                const today = new Date().toISOString().split('T')[0];
                if (birth_date > today) {
                    alert("ä½ æ˜¯æœªä¾†äººï¼Ÿï¼");
                    return;
                }
            }

            try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name, email, phone, birth_date, gender })
                });

                const data = await res.json();
                if (res.ok) {
                    alert('è¨»å†ŠæˆåŠŸï¼æ­¡è¿ ' + data.user.name);
                    location.reload();
                } else {
                    alert(data.error);
                }
            } catch (err) {
                console.error(err);
                alert("é€£ç·šéŒ¯èª¤");
            }
        }

                // æœå°‹æˆ¿é–“ (åˆ†çµ„é¡¯ç¤º + ä¸‹æ‹‰é¸å–® + å‰©é¤˜æ•¸é‡)
        async function searchRooms() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const cap = document.getElementById('capacity').value;

            if (!start || !end) return alert("è«‹é¸æ“‡æ—¥æœŸ");
            if (start >= end) return alert("é€€æˆ¿æ—¥æœŸå¿…é ˆæ™šæ–¼å…¥ä½æ—¥æœŸ");

            try {
                // ä½¿ç”¨ GET Query String å‚³éåƒæ•¸
                const res = await fetch(`/api/search?start_date=${start}&end_date=${end}&capacity=${cap}`);
                const groupedRooms = await res.json();
                
                if (groupedRooms.error) return alert(groupedRooms.error);

                const list = document.getElementById('room-list');
                // å¦‚æœå›å‚³æ˜¯ç©ºçš„ï¼Œé¡¯ç¤ºæç¤º
                list.innerHTML = groupedRooms.length ? '' : '<div class="col-12 text-center">æ²’æœ‰ç¬¦åˆçš„ç©ºæˆ¿</div>';

                // groupedRooms å›å‚³çš„æ˜¯ [{ type_name:..., available_rooms: [...] }, ...]
                groupedRooms.forEach((group, index) => {
                    // è¨ˆç®—å‰©é¤˜é–“æ•¸
                    const remainingCount = group.available_rooms.length;
                    
                    // ç”¢ç”Ÿä¸‹æ‹‰é¸å–®é¸é …
                    let optionsHtml = '';
                    group.available_rooms.forEach(r => {
                        optionsHtml += `<option value="${r.room_id}">${r.room_number}</option>`;
                    });
                    
                    // æ ¹æ“šå‰©é¤˜æ•¸é‡æ±ºå®šé¡è‰² (å°‘æ–¼3é–“é¡¯ç¤ºç´…è‰²è­¦å‘Š)
                    const countBadgeClass = remainingCount < 3 ? 'bg-danger' : 'bg-success';

                    // ä½¿ç”¨ Template Literals (åå¼•è™Ÿ) çµ„åˆ HTML å­—ä¸²ï¼Œç”¢ç”Ÿå¡ç‰‡ HTML
                    list.innerHTML += `
                        <div class="col-md-6 mb-4">
                            <div class="card h-100 shadow-sm border-0">
                                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">${group.type_name}</h5>
                                    <span class="badge ${countBadgeClass}">å‰©é¤˜: ${remainingCount} é–“</span>
                                </div>
                                <div class="card-body">
                                    <p class="card-text text-muted">${group.description}</p>
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <span class="badge bg-secondary rounded-pill">å¯ä½ ${group.capacity} äºº</span>
                                        <h4 class="text-primary mb-0">$${group.base_price} <small class="text-muted fs-6">/ æ™š</small></h4>
                                    </div>
                                    
                                    <div class="form-floating mb-3">
                                        <select class="form-select" id="roomSelect-${index}">
                                            ${optionsHtml}
                                        </select>
                                        <label>é¸æ“‡æˆ¿è™Ÿ</label>
                                    </div>

                                    <button class="btn btn-primary w-100 py-2" onclick="bookRoomBySelect(${index})">
                                        ç«‹å³é è¨‚
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                showSection('search-section');
                document.getElementById('room-list').style.display = 'flex';
            } catch (err) {
                console.error(err);
            }
        }


        // é è¨‚åŠŸèƒ½ (é…åˆä¸‹æ‹‰é¸å–®)
        async function bookRoomBySelect(index) {
            // æ ¹æ“šå‚³å…¥çš„ index æ‰¾åˆ°å°æ‡‰çš„ä¸‹æ‹‰é¸å–®
            const select = document.getElementById(`roomSelect-${index}`);
            if (!select) return;
            
            const roomId = select.value;
            // å–å¾—é¸å–®æ–‡å­—(æˆ¿è™Ÿ)
            const roomNumber = select.options[select.selectedIndex].text;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            
            if(!confirm(`ç¢ºå®šè¦é è¨‚å—ï¼Ÿ\næˆ¿è™Ÿ: ${roomNumber}\nå…¥ä½: ${start}\né€€æˆ¿: ${end}`)) return;

            try {
                const res = await fetch('/api/book', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ room_id: roomId, start_date: start, end_date: end })
                });
                
                // ç‹€æ…‹ç¢¼ 401 ä»£è¡¨æœªç™»å…¥ï¼Œå¼·åˆ¶é¡¯ç¤ºç™»å…¥æ¡†
                const data = await res.json();
                if(res.status === 401) {
                    alert("è«‹å…ˆç™»å…¥æœƒå“¡");
                    var myModal = new bootstrap.Modal(document.getElementById('loginModal'));
                    myModal.show();
                } else if(res.ok) {
                    alert("é è¨‚æˆåŠŸï¼ç¸½é‡‘é¡: $" + data.total_price);
                    showMyBookings(); // é è¨‚å®Œç›´æ¥è·³è½‰åˆ°è¨‚å–®é é¢
                } else {
                    alert(data.error);
                }
            } catch (err) {
                console.error(err);
            }
        }

        // é¡¯ç¤ºæˆ‘çš„è¨‚å–®
        async function showMyBookings() {
            showSection('my-bookings');
            try {
                const res = await fetch('/api/my-bookings');
                const bookings = await res.json();
                const list = document.getElementById('booking-list');
                list.innerHTML = '';
                
                if(bookings.length === 0) {
                    list.innerHTML = '<p class="text-center text-muted">ç›®å‰æ²’æœ‰è¨‚å–®</p>';
                    return;
                }

                bookings.forEach(b => {
                    // æ‰‹å‹•æ ¼å¼åŒ–æ—¥æœŸå­—ä¸²ï¼Œé¿å… JavaScript è‡ªå‹•è½‰æ›æ™‚å€å°è‡´æ—¥æœŸè·‘æ‰
                    const d1 = new Date(b.check_in_date);
                    const d2 = new Date(b.check_out_date);
                    
                    // .padStart(2,'0') ç”¨ä¾†è£œé›¶ï¼Œä¾‹å¦‚ 5æœˆ è®Šæˆ '05'
                    const inDateStr = d1.getFullYear() + '-' + (d1.getMonth()+1).toString().padStart(2,'0') + '-' + d1.getDate().toString().padStart(2,'0');
                    const outDateStr = d2.getFullYear() + '-' + (d2.getMonth()+1).toString().padStart(2,'0') + '-' + d2.getDate().toString().padStart(2,'0');

                    // æ‰‹å‹•åŠ ä¸Šå›ºå®šçš„å…¥ä½/é€€æˆ¿æ™‚é–“
                    // å…¥ä½æ˜¯ 15:00ï¼Œé€€æˆ¿æ˜¯ 11:00
                    const checkInDisplay = `${inDateStr} 15:00`;
                    const checkOutDisplay = `${outDateStr} 11:00`;
                    
                    // æ ¹æ“šç‹€æ…‹æ”¹è®Šæ–‡å­—é¡è‰² (CSS Class)
                    const statusColor = b.status === 'Cancelled' ? 'text-danger' : 'text-success';
                    // åªæœ‰ Confirm ç‹€æ…‹çš„è¨‚å–®æ‰é¡¯ç¤ºå–æ¶ˆæŒ‰éˆ•
                    const actionBtn = b.status === 'Confirmed' 
                        ? `<button class="btn btn-sm btn-outline-danger float-end" onclick="cancelBooking(${b.reservation_id})">å–æ¶ˆè¨‚å–®</button>` 
                        : '<span class="float-end text-muted">ç„¡æ³•å–æ¶ˆ</span>';
                    
                    list.innerHTML += `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">æˆ¿è™Ÿ ${b.room_number} (${b.type_name})</h5>
                                <small class="text-muted">è¨‚å–®æˆç«‹: ${new Date(b.created_at).toLocaleDateString()}</small>
                            </div>
                            <!-- é€™è£¡æ”¹æˆé¡¯ç¤ºåŠ ä¸Šæ™‚é–“çš„ç‰ˆæœ¬ -->
                            <p class="mb-1">å…¥ä½: ${checkInDisplay} | é€€æˆ¿: ${checkOutDisplay}</p>
                            <p class="mb-1 fw-bold">ç¸½åƒ¹: $${b.total_price}</p>
                            <small class="${statusColor} fw-bold">ç‹€æ…‹: ${b.status}</small>
                            ${actionBtn}
                        </div>
                    `;
                });

            } catch (err) {
                console.error(err);
            }
        }

        // å–æ¶ˆè¨‚å–®
        async function cancelBooking(id) {
            if(!confirm("ç¢ºå®šè¦å–æ¶ˆé€™ç­†è¨‚å–®å—ï¼Ÿ")) return;
            try {
                const res = await fetch('/api/cancel', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ reservation_id: id })
                });
                if(res.ok) {
                    alert("å·²å–æ¶ˆ");
                    showMyBookings(); // é‡æ–°æ•´ç†åˆ—è¡¨
                }
            } catch (err) {
                console.error(err);
            }
        }

        // é¡¯ç¤ºæœƒå“¡è³‡æ–™
        async function showProfile() {
            showSection('profile-section');
            try {
                const res = await fetch('/api/profile');
                if(res.status === 401) return location.reload();
                const user = await res.json();
                
                // å°‡å¾Œç«¯æŠ“å›ä¾†çš„è³‡æ–™å¡«å…¥ input
                document.getElementById('p_name').value = user.name;
                document.getElementById('p_email').value = user.email;
                document.getElementById('p_phone').value = user.phone;
                document.getElementById('p_birth').value = user.birth_date || '';
                document.getElementById('p_gender').value = user.gender || '';
            } catch (err) {
                console.error(err);
            }
        }

        // æ›´æ–°æœƒå“¡è³‡æ–™
        async function updateProfile() {
            // è’é›†è¡¨å–®è³‡æ–™
            const data = {
                name: document.getElementById('p_name').value,
                email: document.getElementById('p_email').value,
                phone: document.getElementById('p_phone').value,
                birth_date: document.getElementById('p_birth').value,
                gender: document.getElementById('p_gender').value
            };
            
            try {
                const res = await fetch('/api/profile', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if(res.ok) alert("è³‡æ–™å·²æ›´æ–°");
                else alert("æ›´æ–°å¤±æ•—");
            } catch (err) {
                console.error(err);
            }
        }

        // é é¢åˆ‡æ› helper
        function showSection(id) {
            document.getElementById('search-section').style.display = 'none';
            document.getElementById('room-list').style.display = 'none';
            document.getElementById('my-bookings').style.display = 'none';
            document.getElementById('profile-section').style.display = 'none';
            
            document.getElementById(id).style.display = 'block';
        }
        function showSearch() { 
            showSection('search-section'); 
            document.getElementById('room-list').style.display = 'flex';
        }
    </script>

</body>
</html>
