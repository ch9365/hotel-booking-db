<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£¯åº—è¨‚æˆ¿ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 20px; background-color: #f8f9fa; }
        .status-Confirmed { color: green; font-weight: bold; }
        .status-Cancelled { color: red; text-decoration: line-through; }
    </style>
</head>
<body>
<div class="container">
    <div class="d-flex justify-content-between mb-4">
        <h1> é£¯åº—è¨‚æˆ¿ç³»çµ±</h1>
        <div id="userArea"></div>
    </div>
    
    <ul class="nav nav-pills mb-3">
        <li class="nav-item"><button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-pane">ğŸ” æœå°‹</button></li>
        <li class="nav-item"><button class="nav-link" id="booking-tab" data-bs-toggle="tab" data-bs-target="#booking-pane" onclick="loadBookings()">ğŸ“… è¨‚å–®</button></li>
        <li class="nav-item"><button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile-pane" onclick="loadProfile()">ğŸ‘¤ æœƒå“¡</button></li>
    </ul>

    <div class="tab-content">
        <!-- æœå°‹ -->
        <div class="tab-pane fade show active" id="search-pane">
            <div class="card p-4 mb-4">
                <div class="row g-3">
                    <div class="col-md-3"><input type="date" id="startDate" class="form-control"></div>
                    <div class="col-md-3"><input type="date" id="endDate" class="form-control"></div>
                    <div class="col-md-3">
                        <select id="capacity" class="form-select">
                            <option value="0">ä¸é™</option>
                            <option value="2">2äºº</option>
                            <option value="4">4äºº</option>
                        </select>
                    </div>
                    <div class="col-md-3"><button onclick="searchRooms()" class="btn btn-primary w-100">æœå°‹</button></div>
                </div>
            </div>
            <div id="resultsArea" class="row"></div>
        </div>

        <!-- è¨‚å–® -->
        <div class="tab-pane fade" id="booking-pane">
            <div id="bookingList" class="list-group"></div>
        </div>

        <!-- æœƒå“¡ -->
        <div class="tab-pane fade" id="profile-pane">
            <div class="card p-4 mx-auto" style="max-width:500px">
                <h4 class="mb-3">æœƒå“¡è³‡æ–™</h4>
                <div class="mb-3"><label>å§“å</label><input type="text" id="pfName" class="form-control"></div>
                <div class="mb-3"><label>Email</label><input type="email" id="pfEmail" class="form-control"></div>
                <div class="mb-3"><label>æ‰‹æ©Ÿ</label><input type="text" id="pfPhone" class="form-control"></div>
                <div class="mb-3"><label>ç”Ÿæ—¥</label><input type="date" id="pfBirth" class="form-control"></div>
                <div class="mb-3"><label>æ€§åˆ¥</label>
                    <select id="pfGender" class="form-select">
                        <option value="">è«‹é¸æ“‡</option><option value="Male">ç”·</option><option value="Female">å¥³</option>
                    </select>
                </div>
                <button onclick="saveProfile()" class="btn btn-success w-100">å„²å­˜</button>
            </div>
        </div>
    </div>
</div>

<!-- ç™»å…¥ Modal -->
<div class="modal fade" id="loginModal">
    <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5>æœƒå“¡ç™»å…¥</h5></div>
        <div class="modal-body">
            <input type="text" id="loginName" class="form-control mb-2" placeholder="å§“å">
            <input type="email" id="loginEmail" class="form-control mb-2" placeholder="Email">
            <input type="text" id="loginPhone" class="form-control" placeholder="æ‰‹æ©Ÿ">
        </div>
        <div class="modal-footer"><button onclick="doLogin()" class="btn btn-primary w-100">ç™»å…¥</button></div>
    </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let curUser = {{ user|tojson|safe }};

function init() {
    const area = document.getElementById('userArea');
    if (curUser) area.innerHTML = `<span>Hi, ${curUser.name}</span> <a href="/api/logout" class="btn btn-sm btn-outline-secondary">ç™»å‡º</a>`;
    else area.innerHTML = `<button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#loginModal">ç™»å…¥</button>`;
}
init();

async function doLogin() {
    const res = await fetch('/api/login', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
            name: document.getElementById('loginName').value,
            email: document.getElementById('loginEmail').value,
            phone: document.getElementById('loginPhone').value
        })
    });
    if(res.ok) location.reload();
    else alert((await res.json()).error);
}

async function searchRooms() {
    const s=document.getElementById('startDate').value, e=document.getElementById('endDate').value, c=document.getElementById('capacity').value;
    if(!s||!e) return alert('è«‹é¸æ—¥æœŸ');
    const res = await fetch(`/api/search?start_date=${s}&end_date=${e}&capacity=${c}`);
    const rooms = await res.json();
    const div = document.getElementById('resultsArea'); div.innerHTML='';
    
    const groups={};
    rooms.forEach(r => {
        if(!groups[r.type_name]) groups[r.type_name]={info:r, list:[]};
        groups[r.type_name].list.push(r);
    });

    Object.keys(groups).forEach(k => {
        const g = groups[k], info=g.info;
        let opts = ''; g.list.forEach(r => opts+=`<option value="${r.room_id}">${r.room_number}</option>`);
        div.innerHTML += `
        <div class="col-md-6 mb-3"><div class="card h-100 shadow-sm p-3">
            <h4>${k} <span class="badge bg-info text-dark">${info.capacity}äºº</span></h4>
            <h3 class="text-primary">$${info.base_price}</h3>
            <p>${info.description}</p>
            <div class="input-group">
                <select id="sel-${k}" class="form-select">${opts}</select>
                <button class="btn btn-primary" onclick="book('${k}')">é è¨‚</button>
            </div>
        </div></div>`;
    });
}

async function book(k) {
    if(!curUser) { new bootstrap.Modal(document.getElementById('loginModal')).show(); return; }
    const sel = document.getElementById(`sel-${k}`);
    const s=document.getElementById('startDate').value, e=document.getElementById('endDate').value;
    
    if(confirm('ç¢ºå®šé è¨‚?')) {
        const res = await fetch('/api/book', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({room_id: sel.value, start_date:s, end_date:e})
        });
        if(res.ok) { alert('æˆåŠŸ'); document.getElementById('booking-tab').click(); }
    }
}

async function loadBookings() {
    if(!curUser) return;
    const res = await fetch('/api/my-bookings');
    const list = document.getElementById('bookingList'); list.innerHTML='';
    (await res.json()).forEach(b => {
        const btn = b.status==='Confirmed' ? `<button onclick="cancel(${b.reservation_id})" class="btn btn-danger btn-sm float-end">å–æ¶ˆ</button>`:'';
        list.innerHTML += `<div class="list-group-item p-3">${btn}<h5>${b.type_name} (${b.room_number})</h5><small>${b.check_in_date}~${b.check_out_date}</small><br><b>$${b.total_price}</b> <span class="status-${b.status}">${b.status}</span></div>`;
    });
}

async function cancel(id) {
    if(confirm('ç¢ºå®šå–æ¶ˆ?')) {
        await fetch('/api/cancel', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({reservation_id:id})});
        loadBookings();
    }
}

async function loadProfile() {
    if(!curUser) return;
    const u = await (await fetch('/api/profile')).json();
    document.getElementById('pfName').value=u.name||'';
    document.getElementById('pfEmail').value=u.email||'';
    document.getElementById('pfPhone').value=u.phone||'';
    document.getElementById('pfBirth').value=u.birth_date||'';
    document.getElementById('pfGender').value=u.gender||'';
}

async function saveProfile() {
    const res = await fetch('/api/profile', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
            name: document.getElementById('pfName').value,
            email: document.getElementById('pfEmail').value,
            phone: document.getElementById('pfPhone').value,
            birth_date: document.getElementById('pfBirth').value,
            gender: document.getElementById('pfGender').value
        })
    });
    if(res.ok) { alert('æ›´æ–°æˆåŠŸ'); location.reload(); }
    else alert('æ›´æ–°å¤±æ•—');
}
</script>
</body>
</html>
