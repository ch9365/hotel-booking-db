<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£¯åº—è¨‚æˆ¿ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 20px; background-color: #f8f9fa; }
        .status-Confirmed { color: green; font-weight: bold; }
        .status-Cancelled { color: red; text-decoration: line-through; }
    </style>
</head>
<body>
<div class="container">
    <div class="d-flex justify-content-between mb-4">
        <h1 class="fw-bold text-primary">é£¯åº—è¨‚æˆ¿ç³»çµ±</h1>
        <div id="userArea"></div>
    </div>
    
    <ul class="nav nav-pills mb-3">
        <li class="nav-item"><button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-pane">ğŸ” æœå°‹</button></li>
        <li class="nav-item"><button class="nav-link" id="booking-tab" data-bs-toggle="tab" data-bs-target="#booking-pane" onclick="loadBookings()">ğŸ“… è¨‚å–®</button></li>
        <li class="nav-item"><button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile-pane" onclick="loadProfile()">ğŸ‘¤ æœƒå“¡</button></li>
    </ul>

    <div class="tab-content">
        <!-- æœå°‹ -->
        <div class="tab-pane fade show active" id="search-pane">
            <div class="card p-4 mb-4">
                <div class="row g-3">
                    <div class="col-md-3"><label class="fw-bold">å…¥ä½</label><input type="date" id="startDate" class="form-control"></div>
                    <div class="col-md-3"><label class="fw-bold">é€€æˆ¿</label><input type="date" id="endDate" class="form-control"></div>
                    <div class="col-md-3"><label class="fw-bold">äººæ•¸</label>
                        <select id="capacity" class="form-select">
                            <option value="0">ä¸é™</option><option value="2">2äºº</option><option value="4">4äºº</option>
                        </select>
                    </div>
                    <div class="col-md-3 align-self-end"><button onclick="searchRooms()" class="btn btn-primary w-100">æœå°‹</button></div>
                </div>
            </div>
            <div id="resultsArea" class="row"></div>
        </div>

        <!-- è¨‚å–® -->
        <div class="tab-pane fade" id="booking-pane">
            <div class="card p-4">
                <h4 class="mb-3">æˆ‘çš„é è¨‚ç´€éŒ„</h4>
                <div id="bookingList" class="list-group"></div>
            </div>
        </div>

        <!-- æœƒå“¡ -->
        <div class="tab-pane fade" id="profile-pane">
            <div class="card p-4 mx-auto" style="max-width:500px">
                <h4 class="mb-3">æœƒå“¡è³‡æ–™</h4>
                <div class="mb-3"><label>å§“å</label><input type="text" id="pfName" class="form-control"></div>
                <div class="mb-3"><label>Email</label><input type="email" id="pfEmail" class="form-control"></div>
                <div class="mb-3"><label>æ‰‹æ©Ÿ</label><input type="text" id="pfPhone" class="form-control"></div>
                <div class="mb-3"><label>ç”Ÿæ—¥</label><input type="date" id="pfBirth" class="form-control"></div>
                <div class="mb-3"><label>æ€§åˆ¥</label>
                    <select id="pfGender" class="form-select">
                        <option value="">è«‹é¸æ“‡</option><option value="Male">ç”·</option><option value="Female">å¥³</option>
                    </select>
                </div>
                <button onclick="saveProfile()" class="btn btn-success w-100">å„²å­˜</button>
            </div>
        </div>
    </div>
</div>

<!-- ç™»å…¥ Modal -->
<div class="modal fade" id="loginModal">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
        <div class="modal-header bg-primary text-white"><h5>æœƒå“¡ç™»å…¥</h5></div>
        <div class="modal-body p-4">
            <input type="text" id="loginName" class="form-control mb-3" placeholder="å§“å (æ–°ç”¨æˆ¶å¿…å¡«)">
            <input type="email" id="loginEmail" class="form-control mb-3" placeholder="Email">
            <input type="text" id="loginPhone" class="form-control" placeholder="æ‰‹æ©Ÿ">
            <div class="text-muted small mt-2">éœ€å¡«å¯«æ­£ç¢ºè³‡æ–™ä»¥ç™»å…¥èˆŠå¸³è™Ÿ</div>
        </div>
        <div class="modal-footer border-0"><button onclick="doLogin()" class="btn btn-primary w-100">ç™»å…¥ / è¨»å†Š</button></div>
    </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let curUser = {{ user|tojson|safe }};

function init() {
    const area = document.getElementById('userArea');
    const today = new Date().toISOString().split('T')[0]; // 1. å…ˆå®šç¾© today

    // --- è¨­å®šæœå°‹æ—¥æœŸé™åˆ¶ (ä¸ç®¡æœ‰æ²’æœ‰ç™»å…¥éƒ½è¦åš) ---
    const startInput = document.getElementById('startDate');
    const endInput = document.getElementById('endDate');
    
    if (startInput) {
        startInput.min = today;
        startInput.addEventListener('change', function() {
            endInput.min = this.value;
            // ç‚ºäº†æ›´å‹å–„ï¼Œå¦‚æœä¸å°å¿ƒé¸äº†æ¯”å…¥ä½æ—¥æ—©çš„é€€æˆ¿æ—¥ï¼Œè‡ªå‹•æ¸…ç©ºé€€æˆ¿æ—¥
            if (endInput.value && endInput.value < this.value) {
                endInput.value = '';
            }
        });
    }

    // --- è¨­å®šç”Ÿæ—¥é™åˆ¶ (ä¸ç®¡æœ‰æ²’æœ‰ç™»å…¥éƒ½è¦åš) ---
    const birthInput = document.getElementById('pfBirth');
    if (birthInput) {
        birthInput.max = today;
    }

    // --- ç™»å…¥ç‹€æ…‹åˆ¤æ–· ---
    if (curUser) {
        area.innerHTML = `<span class="me-2">Hi, <strong>${curUser.name}</strong></span> <a href="/api/logout" class="btn btn-sm btn-outline-secondary">ç™»å‡º</a>`;
        
        // æª¢æŸ¥æ˜¯å¦æœ‰æš«å­˜çš„è¨‚æˆ¿è«‹æ±‚
        const pending = localStorage.getItem('pendingBooking');
        if (pending) {
            const data = JSON.parse(pending);
            localStorage.removeItem('pendingBooking');
            document.getElementById('startDate').value = data.start;
            document.getElementById('endDate').value = data.end;
            setTimeout(() => { bookRoom(data.roomId, data.roomNum); }, 500);
        }
    } else {
        area.innerHTML = `<button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#loginModal">æœƒå“¡ç™»å…¥</button>`;
    }
}
init();

async function doLogin() {
    const name = document.getElementById('loginName').value;
    const email = document.getElementById('loginEmail').value;
    const phone = document.getElementById('loginPhone').value;
    
    if(!email || !phone) return alert('è«‹å®Œæ•´å¡«å¯« Email å’Œ æ‰‹æ©Ÿ');

    try {
        const res = await fetch('/api/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, email, phone})
        });
        
        const contentType = res.headers.get("content-type");
        if (!contentType || !contentType.includes("application/json")) {
            // å¦‚æœå›å‚³çš„ä¸æ˜¯ JSON (ä¾‹å¦‚ 500 Error HTML)ï¼ŒæŠŠå®ƒå°å‡ºä¾†
            const text = await res.text();
            throw new Error("Server Error: " + text.substring(0, 100)); // åªé¡¯ç¤ºå‰100å­—é¿å…å¤ªé•·
        }

        const data = await res.json();

        if(res.ok) {
            location.reload();
        } else {
            alert("ç™»å…¥å¤±æ•—: " + data.error);
        }
    } catch (e) {
        // é€™è£¡æœƒæŠŠè©³ç´°éŒ¯èª¤é¡¯ç¤ºåœ¨å½ˆè·³è¦–çª—
        alert("ç³»çµ±ç™¼ç”ŸéŒ¯èª¤:\n" + e.message);
    }
}


async function searchRooms() {
    const s=document.getElementById('startDate').value, e=document.getElementById('endDate').value, c=document.getElementById('capacity').value;
    if(!s||!e) return alert('è«‹é¸æ—¥æœŸ');
    
    // ã€å‰ç«¯é˜²å‘†ã€‘æª¢æŸ¥æ—¥æœŸ
    if (s >= e) return alert('é€€æˆ¿æ—¥æœŸå¿…é ˆæ™šæ–¼å…¥ä½æ—¥æœŸï¼');

    const res = await fetch(`/api/search?start_date=${s}&end_date=${e}&capacity=${c}`);
    const rooms = await res.json();
    const div = document.getElementById('resultsArea'); div.innerHTML='';
    
    if(rooms.length===0) { div.innerHTML='<div class="col-12 text-center p-5"><h5>ç„¡ç¬¦åˆæ¢ä»¶ç©ºæˆ¿</h5></div>'; return; }

    const groups={};
    rooms.forEach(r => {
        if(!groups[r.type_name]) groups[r.type_name]={info:r, list:[]};
        groups[r.type_name].list.push(r);
    });

    Object.keys(groups).forEach(k => {
        const g = groups[k], info=g.info;
        let opts = ''; g.list.forEach(r => opts+=`<option value="${r.room_id}">${r.room_number}è™Ÿ</option>`);
        div.innerHTML += `
        <div class="col-md-6 mb-4"><div class="card h-100 shadow-sm border-0">
            <div class="card-header bg-white border-0 pt-3 d-flex justify-content-between">
                <h4 class="fw-bold">${k}</h4><span class="badge bg-info text-dark">${info.capacity}äºº</span>
            </div>
            <div class="card-body">
                <h2 class="text-primary fw-bold">$${info.base_price} <small class="fs-6 text-muted">/æ™š</small></h2>
                <p class="text-secondary">${info.description}</p>
                <div class="bg-light p-3 rounded">
                    <div class="input-group">
                        <select id="sel-${k}" class="form-select border-primary">${opts}</select>
                        <button class="btn btn-primary" onclick="bookSelected('${k}')">é è¨‚æ­¤æˆ¿å‹</button>
                    </div>
                    <div class="mt-2 small text-success">å‰©é¤˜ ${g.list.length} é–“</div>
                </div>
            </div>
        </div></div>`;
    });
}

function bookSelected(k) {
    const sel = document.getElementById(`sel-${k}`);
    bookRoom(sel.value, sel.options[sel.selectedIndex].text);
}

async function bookRoom(roomId, roomNum) {
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;

    if(!curUser) { 
        localStorage.setItem('pendingBooking', JSON.stringify({roomId, roomNum, start, end}));
        new bootstrap.Modal(document.getElementById('loginModal')).show(); 
        return; 
    }
    
    const days = (new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24);
    
    if(!confirm(`é è¨‚ç¢ºèªï¼š\næˆ¿è™Ÿï¼š${roomNum}\næ—¥æœŸï¼š${start} ~ ${end} (${days}æ™š)\n\nç¢ºå®šè¦é€å‡ºå—ï¼Ÿ`)) return;

    const res = await fetch('/api/book', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({room_id: roomId, start_date:start, end_date:end})
    });
    
    if(res.ok) { 
        const data = await res.json();
        alert(`ğŸ‰ è¨‚æˆ¿æˆåŠŸï¼\nç¸½é‡‘é¡ï¼š$${data.total_price}`); 
        document.getElementById('booking-tab').click(); 
    } else {
        alert('è¨‚æˆ¿å¤±æ•—');
    }
}

async function loadBookings() {
    if(!curUser) return;
    const res = await fetch('/api/my-bookings');
    const list = document.getElementById('bookingList'); list.innerHTML='';
    (await res.json()).forEach(b => {
        const btn = b.status==='Confirmed' ? `<button onclick="cancel(${b.reservation_id})" class="btn btn-outline-danger btn-sm float-end">å–æ¶ˆ</button>`:'';
        const inDate = b.check_in_date.substring(0, 10);
        const outDate = b.check_out_date.substring(0, 10);
        
        list.innerHTML += `
        <div class="list-group-item p-3 border-0 border-bottom">
            ${btn}
            <h5 class="mb-1 fw-bold text-dark">${b.type_name} <span class="badge bg-light text-dark border ms-2">${b.room_number}</span></h5>
            <small class="text-muted">å…¥ä½ï¼š${inDate} | é€€æˆ¿ï¼š${outDate}</small><br>
            <div class="mt-2">
                <strong class="text-primary fs-5">$${b.total_price}</strong>
                <span class="ms-3 status-${b.status}">${b.status==='Confirmed'?'âœ… å·²ç¢ºèª':'âŒ å·²å–æ¶ˆ'}</span>
            </div>
        </div>`;
    });
}

async function cancel(id) {
    if(confirm('ç¢ºå®šå–æ¶ˆè¨‚å–®ï¼Ÿæˆ¿é–“å°‡ç«‹å³é‡‹å‡ºã€‚')) {
        await fetch('/api/cancel', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({reservation_id:id})});
        alert('å·²å–æ¶ˆ');
        loadBookings();
    }
}

async function loadProfile() {
    if(!curUser) { alert('è«‹å…ˆç™»å…¥'); document.getElementById('search-tab').click(); return; }
    const u = await (await fetch('/api/profile')).json();
    document.getElementById('pfName').value=u.name||'';
    document.getElementById('pfEmail').value=u.email||'';
    document.getElementById('pfPhone').value=u.phone||'';
    document.getElementById('pfBirth').value=u.birth_date||'';
    document.getElementById('pfGender').value=u.gender||'';
}

async function saveProfile() {
    const res = await fetch('/api/profile', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
            name: document.getElementById('pfName').value,
            email: document.getElementById('pfEmail').value,
            phone: document.getElementById('pfPhone').value,
            birth_date: document.getElementById('pfBirth').value,
            gender: document.getElementById('pfGender').value
        })
    });
    if(res.ok) { alert('æ›´æ–°æˆåŠŸ'); location.reload(); }
    else alert('æ›´æ–°å¤±æ•—');
}
</script>
</body>
</html>
